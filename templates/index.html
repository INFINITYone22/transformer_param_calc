<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer Parameter Calculator Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0f0f23;
            --secondary-bg: #1a1a2e;
            --card-bg: #16213e;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #06b6d4;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-accent: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            --gradient-dark: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gradient-dark);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: var(--gradient-primary);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--accent-primary);
        }

        .form-section {
            margin-bottom: 25px;
        }

        .section-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tooltip {
            position: relative;
            cursor: help;
            color: var(--text-muted);
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary-bg);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        input, select {
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        input:hover, select:hover {
            border-color: var(--accent-secondary);
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .preset-btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--gradient-secondary);
            color: white;
        }

        .btn-secondary {
            background: var(--gradient-accent);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .metric-subvalue {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .breakdown-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .progress-bar {
            background: var(--secondary-bg);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-secondary);
            transition: width 0.5s ease;
        }

        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .comparison-section {
            grid-column: 1 / -1;
            margin-top: 30px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .comparison-card {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .export-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .advanced-features {
            grid-column: 1 / -1;
            margin-top: 30px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .feature-icon {
            font-size: 2rem;
            color: var(--accent-primary);
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            margin-top: 20px;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .model-scaling {
            margin-top: 30px;
        }

        .scaling-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .scaling-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .scaling-input label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .scaling-input input {
            width: 120px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> Transformer Parameter Calculator Pro</h1>
            <p>Advanced parameter calculation and analysis for transformer models</p>
        </div>

        <div class="main-layout">
            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-cogs"></i>
                    Model Configuration
                </h2>
                
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-magic"></i>
                        Quick Presets
                    </div>
                    <div class="preset-grid">
                        <button class="preset-btn" onclick="loadPreset('GPT-2 Small')">GPT-2 Small</button>
                        <button class="preset-btn" onclick="loadPreset('GPT-2 Medium')">GPT-2 Medium</button>
                        <button class="preset-btn" onclick="loadPreset('GPT-2 Large')">GPT-2 Large</button>
                        <button class="preset-btn" onclick="loadPreset('GPT-3.5')">GPT-3.5</button>
                        <button class="preset-btn" onclick="loadPreset('BERT Base')">BERT Base</button>
                        <button class="preset-btn" onclick="loadPreset('BERT Large')">BERT Large</button>
                        <button class="preset-btn" onclick="loadPreset('T5 Small')">T5 Small</button>
                        <button class="preset-btn" onclick="loadPreset('T5 Base')">T5 Base</button>
                    </div>
                </div>

                <form id="calculatorForm">
                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-layer-group"></i>
                            Architecture
                        </div>
                        <div class="form-grid">
                        <div class="form-group">
                                <label for="d_model">
                                    Model Dimension (d_model)
                                    <i class="fas fa-question-circle tooltip" data-tooltip="The dimensionality of the model embeddings"></i>
                            </label>
                            <input type="number" id="d_model" name="d_model" value="768" min="64" max="8192" step="64">
                        </div>
                        <div class="form-group">
                                <label for="num_layers">
                                    Number of Layers
                                    <i class="fas fa-question-circle tooltip" data-tooltip="Number of transformer layers"></i>
                            </label>
                            <input type="number" id="num_layers" name="num_layers" value="12" min="1" max="100">
                        </div>
                        <div class="form-group">
                                <label for="num_heads">
                                    Number of Heads
                                    <i class="fas fa-question-circle tooltip" data-tooltip="Number of attention heads (must divide d_model)"></i>
                            </label>
                            <input type="number" id="num_heads" name="num_heads" value="12" min="1" max="64">
                        </div>
                        <div class="form-group">
                                <label for="d_ff">
                                    Feed-Forward Dimension
                                    <i class="fas fa-question-circle tooltip" data-tooltip="Hidden dimension in feed-forward network"></i>
                            </label>
                            <input type="number" id="d_ff" name="d_ff" value="3072" min="128" max="32768">
                        </div>
                        <div class="form-group">
                                <label for="vocab_size">
                                    Vocabulary Size
                                    <i class="fas fa-question-circle tooltip" data-tooltip="Number of tokens in vocabulary"></i>
                            </label>
                            <input type="number" id="vocab_size" name="vocab_size" value="50257" min="1000" max="1000000">
                        </div>
                        <div class="form-group">
                                <label for="context_length">
                                    Context Length
                                    <i class="fas fa-question-circle tooltip" data-tooltip="Maximum sequence length"></i>
                            </label>
                            <input type="number" id="context_length" name="context_length" value="1024" min="128" max="32768">
                        </div>
                            <div class="form-group full-width">
                                <label for="model_type">Model Type</label>
                        <select id="model_type" name="model_type">
                            <option value="Decoder-only">Decoder-only (GPT-style)</option>
                            <option value="Encoder-only">Encoder-only (BERT-style)</option>
                            <option value="Encoder-Decoder">Encoder-Decoder (T5-style)</option>
                        </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <i class="fas fa-microchip"></i>
                            Precision Settings
                        </div>
                        <div class="form-grid">
                        <div class="form-group">
                                <label for="precision_type">Weight Precision Type</label>
                            <select id="precision_type" name="precision_type" onchange="updatePrecisionInput('precision')">
                                <option value="standard">Standard (1-32 bits)</option>
                                <option value="binary">Binary (1-bit)</option>
                                <option value="ternary">Ternary (~1.58 bits)</option>
                            </select>
                        </div>
                        <div class="form-group">
                                <label for="precision_bits">Weight Bits</label>
                            <input type="number" id="precision_bits" name="precision_bits" value="32" min="1" max="32" step="0.01">
                        </div>
                        <div class="form-group">
                                <label for="attn_precision_type">Attention Precision Type</label>
                            <select id="attn_precision_type" name="attn_precision_type" onchange="updatePrecisionInput('attn_precision')">
                                <option value="standard">Standard (1-32 bits)</option>
                                <option value="binary">Binary (1-bit)</option>
                                <option value="ternary">Ternary (~1.58 bits)</option>
                            </select>
                        </div>
                        <div class="form-group">
                                <label for="attn_precision_bits">Attention Bits</label>
                            <input type="number" id="attn_precision_bits" name="attn_precision_bits" value="32" min="1" max="32" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="button" class="btn btn-success" onclick="autoConfigureFromDimension()">
                            <i class="fas fa-magic"></i>
                            Auto Configure
                        </button>
                        <button type="submit" class="btn btn-primary" id="calculateBtn">
                            <i class="fas fa-calculator"></i>
                            Calculate Parameters
                        </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Results & Analysis
                </h2>
                <div id="results">
                    <div class="loading">
                        <i class="fas fa-cog"></i>
                        Enter model parameters and click calculate to see results
                    </div>
                </div>
            </div>
        </div>

        <div class="results-container" id="detailedResults" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">Overview</button>
                <button class="tab" onclick="switchTab('breakdown')">Breakdown</button>
                <button class="tab" onclick="switchTab('comparison')">Comparison</button>
                <button class="tab" onclick="switchTab('scaling')">Scaling</button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="results-grid" id="overviewResults">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <div id="breakdown" class="tab-content">
                <div class="breakdown-section" id="breakdownResults">
                    <!-- Breakdown will be populated here -->
                </div>
            </div>

            <div id="comparison" class="tab-content">
                <div class="comparison-section" id="comparisonResults">
                    <!-- Comparison will be populated here -->
                </div>
            </div>

            <div id="scaling" class="tab-content">
                <div class="model-scaling">
                    <div class="scaling-controls">
                        <div class="scaling-input">
                            <label>Scale Factor</label>
                            <input type="number" id="scaleFactor" value="2" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="scaling-input">
                            <label>Target Parameters</label>
                            <input type="text" id="targetParams" placeholder="e.g., 1B, 7B, 175B">
                        </div>
                        <button class="btn btn-secondary" onclick="analyzeScaling()">
                            <i class="fas fa-search"></i>
                            Analyze Scaling
                        </button>
                    </div>
                    <div id="scalingResults">
                        <!-- Scaling analysis will be populated here -->
                    </div>
                </div>
            </div>

            <div class="export-section">
                <div class="section-header">
                    <i class="fas fa-download"></i>
                    Export Results
                </div>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportResults('json')">
                        <i class="fas fa-file-code"></i>
                        Export JSON
                    </button>
                    <button class="btn btn-secondary" onclick="exportResults('csv')">
                        <i class="fas fa-file-csv"></i>
                        Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportResults('txt')">
                        <i class="fas fa-file-alt"></i>
                        Export Report
                    </button>
                    <button class="btn btn-secondary" onclick="shareResults()">
                        <i class="fas fa-share"></i>
                        Share Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let presets = {};
        let currentResults = null;
        let comparisonModels = [];

        // Load presets from server
        fetch('/presets')
            .then(response => response.json())
            .then(data => {
                presets = data;
            });

        function loadPreset(presetName) {
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('d_model').value = preset.d_model;
                document.getElementById('num_layers').value = preset.num_layers;
                document.getElementById('num_heads').value = preset.num_heads;
                document.getElementById('d_ff').value = preset.d_ff;
                document.getElementById('vocab_size').value = preset.vocab_size;
                document.getElementById('context_length').value = preset.context_length;
                document.getElementById('model_type').value = preset.model_type;
                
                // Auto-calculate after loading preset
                calculateParameters();
            }
        }

        function autoConfigureFromDimension() {
            try {
                const d_model = parseInt(document.getElementById('d_model').value);
                
                if (!d_model || d_model < 64) {
                    alert('Please enter a valid model dimension (d_model) first');
                    return;
                }

                // Calculate recommended values based on common transformer scaling rules
                const recommendedHeads = Math.max(1, d_model / 64);
                const recommendedDff = 4 * d_model;
                
                // Set the calculated values
                document.getElementById('num_heads').value = recommendedHeads;
                document.getElementById('d_ff').value = recommendedDff;
                
                // Set common defaults
                document.getElementById('vocab_size').value = '50257';
                document.getElementById('context_length').value = '1024';
                document.getElementById('precision_type').value = 'standard';
                document.getElementById('precision_bits').value = 32;
                document.getElementById('attn_precision_type').value = 'standard';
                document.getElementById('attn_precision_bits').value = 32;
                
                // Auto-calculate after configuration
                calculateParameters();
                
                // Show feedback
                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Configured!';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = 'linear-gradient(135deg, var(--success) 0%, #059669 100%)';
                }, 1500);
                
            } catch (error) {
                alert('Error in auto-configuration. Please check your model dimension input.');
                         }
         }

         function updatePrecisionInput(type) {
             const selectElement = document.getElementById(type + '_type');
             const inputElement = document.getElementById(type + '_bits');
             const selectedValue = selectElement.value;
             
             if (selectedValue === 'binary') {
                 inputElement.value = 1;
                 inputElement.disabled = true;
                inputElement.style.backgroundColor = 'var(--secondary-bg)';
                inputElement.style.opacity = '0.6';
             } else if (selectedValue === 'ternary') {
                inputElement.value = 1.585;
                 inputElement.disabled = true;
                inputElement.style.backgroundColor = 'var(--secondary-bg)';
                inputElement.style.opacity = '0.6';
             } else {
                 inputElement.disabled = false;
                inputElement.style.backgroundColor = 'var(--secondary-bg)';
                inputElement.style.opacity = '1';
                 if (inputElement.value == 1 || inputElement.value == 1.585) {
                    inputElement.value = 32;
                 }
             }
             
             // Trigger calculation update
             if (typeof calculateParameters === 'function') {
                 clearTimeout(window.autoCalcTimeout);
                 window.autoCalcTimeout = setTimeout(calculateParameters, 300);
             }
         }

         function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toString();
        }

                 function calculateParameters() {
             const form = document.getElementById('calculatorForm');
             const formData = new FormData(form);
             const data = Object.fromEntries(formData);

             // Ensure precision types are included
             data.precision_type = document.getElementById('precision_type').value;
             data.attn_precision_type = document.getElementById('attn_precision_type').value;

             const calculateBtn = document.getElementById('calculateBtn');
             calculateBtn.disabled = true;
            calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';

            document.getElementById('results').innerHTML = '<div class="loading"><i class="fas fa-cog fa-spin"></i> Calculating parameters...</div>';

             fetch('/calculate', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                 },
                 body: JSON.stringify(data)
             })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    document.getElementById('results').innerHTML = 
                        `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${result.error}</div>`;
                } else {
                    currentResults = result;
                    displayResults(result);
                    displayDetailedResults(result);
                }
            })
            .catch(error => {
                document.getElementById('results').innerHTML = 
                    `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            })
            .finally(() => {
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = '<i class="fas fa-calculator"></i> Calculate Parameters';
            });
        }

        function displayResults(result) {
            const resultsHTML = `
                <div class="results-grid">
                    <div class="metric-card">
                        <div class="metric-label">
                            <i class="fas fa-database"></i>
                            Total Parameters
                    </div>
                        <div class="metric-value">${formatNumber(result.total_params)}</div>
                        <div class="metric-subvalue">${result.params_formatted}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            <i class="fas fa-memory"></i>
                            Memory Required
                    </div>
                        <div class="metric-value">${result.memory_formatted}</div>
                        <div class="metric-subvalue">${result.memory_gb >= 1 ? (result.memory_gb * 1024).toFixed(0) + ' MB' : ''}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            <i class="fas fa-eye"></i>
                            Attention Parameters
                    </div>
                        <div class="metric-value">${formatNumber(result.attn_params)}</div>
                        <div class="metric-subvalue">${(result.attn_params / result.total_params * 100).toFixed(1)}% of total</div>
                     </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            <i class="fas fa-bolt"></i>
                            FLOPs per Token
                 </div>
                        <div class="metric-value">${formatNumber(result.flops_per_token)}</div>
                        <div class="metric-subvalue">Forward pass</div>
                     </div>
                     </div>
            `;
            document.getElementById('results').innerHTML = resultsHTML;
        }

        function displayDetailedResults(result) {
            document.getElementById('detailedResults').style.display = 'block';
            
            // Overview tab
            const overviewHTML = `
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-database"></i> Total Parameters</div>
                    <div class="metric-value">${formatNumber(result.total_params)}</div>
                    <div class="metric-subvalue">${result.params_formatted}</div>
                     </div>
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-memory"></i> Memory Required</div>
                    <div class="metric-value">${result.memory_formatted}</div>
                    <div class="metric-subvalue">${result.memory_gb >= 1 ? (result.memory_gb * 1024).toFixed(0) + ' MB' : ''}</div>
                 </div>
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-eye"></i> Attention Parameters</div>
                    <div class="metric-value">${formatNumber(result.attn_params)}</div>
                    <div class="metric-subvalue">${(result.attn_params / result.total_params * 100).toFixed(1)}% of total</div>
                     </div>
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-network-wired"></i> Non-Attention Parameters</div>
                    <div class="metric-value">${formatNumber(result.non_attn_params)}</div>
                    <div class="metric-subvalue">${(result.non_attn_params / result.total_params * 100).toFixed(1)}% of total</div>
                     </div>
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-language"></i> Embedding Parameters</div>
                    <div class="metric-value">${formatNumber(result.embed_params)}</div>
                    <div class="metric-subvalue">${(result.embed_params / result.total_params * 100).toFixed(1)}% of total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label"><i class="fas fa-bolt"></i> FLOPs per Token</div>
                    <div class="metric-value">${formatNumber(result.flops_per_token)}</div>
                    <div class="metric-subvalue">Forward pass computation</div>
                 </div>
            `;
            document.getElementById('overviewResults').innerHTML = overviewHTML;
            
            // Breakdown tab
            const breakdownHTML = `
                <h3><i class="fas fa-chart-pie"></i> Parameter Distribution</h3>
                <div class="breakdown-grid">
                    <div class="metric-card">
                        <div class="metric-label">Attention Layers</div>
                        <div class="metric-value">${(result.attn_params / result.total_params * 100).toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${result.attn_params / result.total_params * 100}%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Feed-Forward Layers</div>
                        <div class="metric-value">${((result.total_params - result.attn_params - result.embed_params) / result.total_params * 100).toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(result.total_params - result.attn_params - result.embed_params) / result.total_params * 100}%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Embeddings</div>
                        <div class="metric-value">${(result.embed_params / result.total_params * 100).toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${result.embed_params / result.total_params * 100}%"></div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <h3><i class="fas fa-microchip"></i> Precision Details</h3>
                    <div class="breakdown-grid">
                        <div class="metric-card">
                            <div class="metric-label">Weight Precision</div>
                            <div class="metric-value">${result.precision_info.weight_type}</div>
                            <div class="metric-subvalue">${result.precision_info.weight_bits.toFixed(2)} bits per parameter</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Attention Precision</div>
                            <div class="metric-value">${result.precision_info.attention_type}</div>
                            <div class="metric-subvalue">${result.precision_info.attention_bits.toFixed(2)} bits per parameter</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('breakdownResults').innerHTML = breakdownHTML;
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function analyzeScaling() {
            if (!currentResults) {
                alert('Please calculate parameters first');
                return;
            }

            const scaleFactor = parseFloat(document.getElementById('scaleFactor').value);
            const targetParams = document.getElementById('targetParams').value;
            
            let scalingHTML = '<h3><i class="fas fa-expand-arrows-alt"></i> Scaling Analysis</h3>';
            
            if (scaleFactor && scaleFactor > 0) {
                const scaledParams = currentResults.total_params * scaleFactor;
                const scaledMemory = currentResults.memory_gb * scaleFactor;
                
                scalingHTML += `
                    <div class="breakdown-grid">
                        <div class="metric-card">
                            <div class="metric-label">Scaled Parameters (${scaleFactor}x)</div>
                            <div class="metric-value">${formatNumber(scaledParams)}</div>
                            <div class="metric-subvalue">${scaledParams.toLocaleString()}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Scaled Memory (${scaleFactor}x)</div>
                            <div class="metric-value">${scaledMemory.toFixed(2)} GB</div>
                            <div class="metric-subvalue">${(scaledMemory * 1024).toFixed(0)} MB</div>
                        </div>
                    </div>
                `;
            }
            
            if (targetParams) {
                const target = parseTargetParams(targetParams);
                if (target) {
                    const requiredScale = target / currentResults.total_params;
                    scalingHTML += `
                        <div class="breakdown-grid">
                            <div class="metric-card">
                                <div class="metric-label">Required Scale Factor</div>
                                <div class="metric-value">${requiredScale.toFixed(2)}x</div>
                                <div class="metric-subvalue">To reach ${formatNumber(target)} parameters</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Required Memory</div>
                                <div class="metric-value">${(currentResults.memory_gb * requiredScale).toFixed(2)} GB</div>
                                <div class="metric-subvalue">At current precision</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('scalingResults').innerHTML = scalingHTML;
        }

        function parseTargetParams(input) {
            const match = input.match(/^(\d+(?:\.\d+)?)\s*([KMGTB]?)$/i);
            if (!match) return null;
            
            const value = parseFloat(match[1]);
            const unit = match[2].toUpperCase();
            
            const multipliers = {
                'K': 1e3,
                'M': 1e6,
                'B': 1e9,
                'T': 1e12
            };
            
            return value * (multipliers[unit] || 1);
        }

        function exportResults(format) {
            if (!currentResults) {
                alert('No results to export. Please calculate parameters first.');
                return;
            }

            const data = {
                ...currentResults,
                timestamp: new Date().toISOString(),
                model_config: {
                    d_model: document.getElementById('d_model').value,
                    num_layers: document.getElementById('num_layers').value,
                    num_heads: document.getElementById('num_heads').value,
                    d_ff: document.getElementById('d_ff').value,
                    vocab_size: document.getElementById('vocab_size').value,
                    context_length: document.getElementById('context_length').value,
                    model_type: document.getElementById('model_type').value,
                    precision_type: document.getElementById('precision_type').value,
                    precision_bits: document.getElementById('precision_bits').value,
                    attn_precision_type: document.getElementById('attn_precision_type').value,
                    attn_precision_bits: document.getElementById('attn_precision_bits').value
                }
            };

            let content, filename, mimeType;

            switch (format) {
                case 'json':
                    content = JSON.stringify(data, null, 2);
                    filename = 'transformer_params.json';
                    mimeType = 'application/json';
                    break;
                case 'csv':
                    content = generateCSV(data);
                    filename = 'transformer_params.csv';
                    mimeType = 'text/csv';
                    break;
                case 'txt':
                    content = generateReport(data);
                    filename = 'transformer_params_report.txt';
                    mimeType = 'text/plain';
                    break;
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateCSV(data) {
            const rows = [
                ['Metric', 'Value'],
                ['Total Parameters', data.total_params],
                ['Memory (GB)', data.memory_gb],
                ['Attention Parameters', data.attn_params],
                ['Non-Attention Parameters', data.non_attn_params],
                ['Embedding Parameters', data.embed_params],
                ['FLOPs per Token', data.flops_per_token]
            ];
            
            return rows.map(row => row.join(',')).join('\n');
        }

        function generateReport(data) {
            return `
Transformer Parameter Calculator Report
Generated: ${new Date().toLocaleString()}

MODEL CONFIGURATION:
- Model Dimension: ${data.model_config.d_model}
- Number of Layers: ${data.model_config.num_layers}
- Number of Heads: ${data.model_config.num_heads}
- Feed-Forward Dimension: ${data.model_config.d_ff}
- Vocabulary Size: ${data.model_config.vocab_size}
- Context Length: ${data.model_config.context_length}
- Model Type: ${data.model_config.model_type}

PRECISION SETTINGS:
- Weight Precision: ${data.precision_info.weight_type} (${data.precision_info.weight_bits} bits)
- Attention Precision: ${data.precision_info.attention_type} (${data.precision_info.attention_bits} bits)

RESULTS:
- Total Parameters: ${data.params_formatted}
- Memory Required: ${data.memory_formatted}
- Attention Parameters: ${data.attn_params.toLocaleString()}
- Non-Attention Parameters: ${data.non_attn_params.toLocaleString()}
- Embedding Parameters: ${data.embed_params.toLocaleString()}
- FLOPs per Token: ${data.flops_per_token.toLocaleString()}

PARAMETER BREAKDOWN:
- Attention: ${(data.attn_params / data.total_params * 100).toFixed(1)}%
- Feed-Forward: ${((data.total_params - data.attn_params - data.embed_params) / data.total_params * 100).toFixed(1)}%
- Embeddings: ${(data.embed_params / data.total_params * 100).toFixed(1)}%
            `.trim();
        }

        function shareResults() {
            if (!currentResults) {
                alert('No results to share. Please calculate parameters first.');
                return;
            }

            const config = {
                d_model: document.getElementById('d_model').value,
                num_layers: document.getElementById('num_layers').value,
                num_heads: document.getElementById('num_heads').value,
                d_ff: document.getElementById('d_ff').value,
                vocab_size: document.getElementById('vocab_size').value,
                context_length: document.getElementById('context_length').value,
                model_type: document.getElementById('model_type').value,
                precision_type: document.getElementById('precision_type').value,
                precision_bits: document.getElementById('precision_bits').value,
                attn_precision_type: document.getElementById('attn_precision_type').value,
                attn_precision_bits: document.getElementById('attn_precision_bits').value
            };

            const params = new URLSearchParams(config);
            const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Share link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this link to share:', shareUrl);
            });
        }

        // Load configuration from URL parameters
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('d_model')) {
                for (const [key, value] of params) {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                    }
                }
                calculateParameters();
            }
        }

        // Form submission handler
        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateParameters();
        });

        // Auto-calculate on input change
        document.getElementById('calculatorForm').addEventListener('input', function() {
            clearTimeout(this.autoCalcTimeout);
            this.autoCalcTimeout = setTimeout(calculateParameters, 500);
        });

        // Initialize
        window.addEventListener('load', function() {
            loadFromUrl();
            setTimeout(() => {
                if (!currentResults) {
                loadPreset('GPT-2 Small');
                }
            }, 100);
        });
    </script>
</body>
</html> 